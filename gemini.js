/* ===================================================
 * ржкрзНрж░ржЬрзЗржХрзНржЯ рж╕рж┐ржЬрзБржХрж╛ - ржмрзНрж░рзЗржЗржи (gemini.js) v1.6 - ржорж╛рж░рзНржЬ ржХрж░рж╛ рж╕ржВрж╕рзНржХрж░ржг
 * - рж╕рж░рзНржмржжрж╛ рж╕ржорзЯ ржУ ржжрж┐ржирзЗрж░ ржЕржВрж╢ AI-ржХрзЗ ржЬрж╛ржирж╛ржирзЛ рж╣рзЯ
 * - рж╕рж╛рж▓рж╛ржо, рж░рж┐ржкрзНрж▓рж╛ржЗ ржЖржмржжрж╛рж░, ржПржмржВ рж╕рж╛ржзрж╛рж░ржг ржЧрж╛рж▓рж┐ ржУрзЯрж╛рж░рзНржирж┐ржВрзЯрзЗрж░ ржЬржирзНржп ржмрж┐рж╢рзЗрж╖ ржкрзНрж░ржорзНржкржЯ рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВ
 * - рж╕рж┐ржЬрзБржХрж╛ржХрзЗ ржЙржжрзНржжрзЗрж╢рзНржп ржХрж░рзЗ ржЧрж╛рж▓рж┐ ржжрж┐рж▓рзЗ рж░рзЛрж╕рзНржЯрж┐ржВ ржирж┐рж░рзНржжрзЗрж╢ржирж╛ ржмрзНржпржмрж╣рж╛рж░
 * - ржорж╛рж▓рзНржЯрж┐-ржХрзА, Teach ржбрзЗржЯрж╛ ржЪрзЗржХ, ржмрзНржпржХрзНрждрж┐рждрзНржм ржЗрждрзНржпрж╛ржжрж┐ ржЕржирзНрждрж░рзНржнрзБржХрзНржд
 * ===================================================
 */

const { GoogleGenerativeAI } = require("@google/generative-ai");
const moment = require("moment-timezone");
const fs = require("fs-extra");
const path = require("path");
const teachManager = require("./utils/teachManager"); // Teach Manager ржЗржорзНржкрзЛрж░рзНржЯ

// === рзз. ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рж▓рзЛржб ===
let config;
try {
  config = JSON.parse(
    fs.readFileSync(path.join(__dirname, "config.json"), "utf8")
  );
} catch (error) {
  console.error("Gemini.js: 'config.json' ржлрж╛ржЗрж▓ржЯрж┐ рж▓рзЛржб ржХрж░рж╛ ржпрж╛рзЯржирж┐ред");
  process.exit(1);
}

// *** API Key-ржПрж░ рж▓рж┐рж╕рзНржЯ рж▓рзЛржб ржХрж░рж╛ ***
const GEMINI_API_KEYS = config.GEMINI_API_KEYS;

// API Key рж▓рж┐рж╕рзНржЯ ржнрзНржпрж╛рж▓рж┐ржб ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рж╛
if (
  !Array.isArray(GEMINI_API_KEYS) ||
  GEMINI_API_KEYS.length === 0 ||
  GEMINI_API_KEYS.some((key) => !key || key.startsWith("YOUR_"))
) {
  console.error(
    "Gemini.js: 'config.json' ржлрж╛ржЗрж▓рзЗ 'GEMINI_API_KEYS' ржЕрзНржпрж╛рж░рзЗ рж╕ржарж┐ржХржнрж╛ржмрзЗ рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯржирж┐ред"
  );
  process.exit(1);
}
console.log(`[Gemini Keys] ${GEMINI_API_KEYS.length} ржЯрж┐ API Key рж▓рзЛржб рж╣рзЯрзЗржЫрзЗред`);

let currentApiKeyIndex = 0; // ржХрзЛржи Key ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржмрзЗ рждрж╛рж░ ржЗржиржбрзЗржХрзНрж╕

// --- Round Robin ржкржжрзНржзрждрж┐рждрзЗ ржкрж░ржмрж░рзНрждрзА API Key ржкрж╛ржУрзЯрж╛рж░ ржлрж╛ржВрж╢ржи ---
function getNextApiKey() {
  const key = GEMINI_API_KEYS[currentApiKeyIndex];
  currentApiKeyIndex = (currentApiKeyIndex + 1) % GEMINI_API_KEYS.length; // ржкрж░ржмрж░рзНрждрзА ржЗржиржбрзЗржХрзНрж╕ (ржЪржХрзНрж░рж╛ржХрж╛рж░рзЗ)
  return key;
}

// === рзи. ржЬрзЗржорж┐ржирж┐ ржоржбрзЗрж▓ ржУ ржмрзНржпржХрзНрждрж┐рждрзНржм рж╕рзЗржЯржЖржк ===
const modelName = "gemini-2.5-flash";
let shizukaPersona = "ржЖржорж┐ рж╕рж┐ржЬрзБржХрж╛, ржЖржкржирж╛рж░ ржмржирзНржзрзБред"; // ржбрж┐ржлрж▓рзНржЯ ржкрж╛рж░рзНрж╕рзЛржирж╛
try {
  shizukaPersona = fs.readFileSync(path.join(__dirname, "persona.txt"), "utf8");
} catch (error) {
  console.warn(
    "Gemini.js: 'persona.txt' ржлрж╛ржЗрж▓ржЯрж┐ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред ржбрж┐ржлрж▓рзНржЯ ржкрж╛рж░рзНрж╕рзЛржирж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред"
  );
}

// === рзй. ржХржиржнрж╛рж░рж╕рзЗрж╢ржи ржХрзНржпрж╛рж╢ ===
const conversationHistory = new Map();
const HISTORY_MAX_AGE_MS = 1 * 60 * 60 * 1000; // рзз ржШржгрзНржЯрж╛
const HISTORY_MAX_LENGTH = 10; // рж╢рзЗрж╖ рззрзжржЯрж┐ ржорзЗрж╕рзЗржЬ

function clearOldHistory() {
  const now = Date.now();
  conversationHistory.forEach((data, threadID) => {
    if (now - data.timestamp > HISTORY_MAX_AGE_MS) {
      conversationHistory.delete(threadID);
      console.log(
        `[History] рзз ржШржгрзНржЯрж╛ ржкрж╛рж░ рж╣ржУрзЯрж╛рзЯ ${threadID} ржЧрзНрж░рзБржкрзЗрж░/ржЗржиржмржХрзНрж╕рзЗрж░ рж╕рзНржорзГрждрж┐ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рж▓рзЛред`
      );
    }
  });
}
setInterval(clearOldHistory, 5 * 60 * 1000);

// === рзк. рж╕ржорзЯ ржУ ржжрж┐ржирзЗрж░ ржЕржВрж╢ ржмрзЗрж░ ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи ===
function getCurrentTimeInfo() {
  const now = moment().tz("Asia/Dhaka");
  const time = now.format("h:mm A"); // рззрзи-ржШржгрзНржЯрж╛ ржлрж░ржорзНржпрж╛ржЯ
  const date = now.format("D MMMM YYYY");
  const day = now.format("dddd");
  let dayPart = "ржжрж┐ржи"; // ржбрж┐ржлрж▓рзНржЯ
  const hour = now.hour();
  if (hour >= 5 && hour < 12) dayPart = "рж╕ржХрж╛рж▓";
  else if (hour >= 12 && hour < 17) dayPart = "ржжрзБржкрзБрж░";
  else if (hour >= 17 && hour < 20) dayPart = "рж╕ржирзНржзрзНржпрж╛";
  else dayPart = "рж░рж╛ржд"; // рзирзж ржерзЗржХрзЗ рзк ржкрж░рзНржпржирзНржд рж░рж╛ржд

  return { time, date, day, dayPart };
}

// === рзл. ржорзВрж▓ рж░рж┐ржкрзНрж▓рж╛ржЗ ржЬрзЗржирж╛рж░рзЗржЯрж░ ржлрж╛ржВрж╢ржи ===
async function getShizukaReply(threadID, userPrompt, senderName = null) {
  // ржХ. ржмрж┐рж╢рзЗрж╖ ржкрзНрж░ржорзНржкржЯ ржХрзА рж╢ржирж╛ржХрзНрждржХрж░ржг
  const SALAM_PROMPT_KEY = "##SALAM_REPLY_REQUEST##";
  const REPLY_PROMPT_KEY = "##REPLY_PROMPT_REQUEST##";
  const BAD_WORD_PROMPT_KEY = "##BAD_WORD_WARNING##";

  let specialPromptInstruction = null; // AI-ржХрзЗ ржжрзЗржУрзЯрж╛ ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢ржирж╛

  if (userPrompt.startsWith(SALAM_PROMPT_KEY)) {
    specialPromptInstruction = `[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ: persona.txt-рждрзЗ "рж╕рж╛рж▓рж╛ржорзЗрж░ ржЙрждрзНрждрж░" ржирж┐рж░рзНржжрзЗрж╢рж┐ржХрж╛ ржЕржирзБржпрж╛рзЯрзА ржПржХржЯрж┐ рж╕рзБржирзНржжрж░, ржнрзНржпрж╛рж░рж┐рзЯрзЗржб ржПржмржВ рж╕рж┐ржЬрзБржХрж╛-рж╕рзНржЯрж╛ржЗрж▓рзЗрж░ рж╕рж╛рж▓рж╛ржорзЗрж░ ржЙрждрзНрждрж░ рждрзИрж░рж┐ ржХрж░рзЛред]`;
    console.log(`[Gemini Special] рж╕рж╛рж▓рж╛ржорзЗрж░ ржЙрждрзНрждрж░ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...`);
    userPrompt = ""; // ржорзВрж▓ ржкрзНрж░ржорзНржкржЯ ржЦрж╛рж▓рж┐, рж╢рзБржзрзБ ржирж┐рж░рзНржжрзЗрж╢ржирж╛ ржмрзНржпржмрж╣рзГржд рж╣ржмрзЗ
  } else if (userPrompt.startsWith(REPLY_PROMPT_KEY)) {
    specialPromptInstruction = `[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ: persona.txt-рждрзЗ "рж░рж┐ржкрзНрж▓рж╛ржЗ ржХрж░рзЗ ржмрж▓рзЛ" ржХрзМрж╢рж▓рзЗрж░ ржирж┐рж░рзНржжрзЗрж╢ржирж╛ ржЕржирзБржпрж╛рзЯрзА ржПржХржЯрж┐ ржорж┐рж╖рзНржЯрж┐, ржмрж╛ржЪрзНржЪрж╛рж░ ржорждрзЛ ржЖржмржжрж╛рж░рзЗрж░ ржмрж╛рж░рзНрждрж╛ рждрзИрж░рж┐ ржХрж░рзЛред]`;
    console.log(`[Gemini Special] рж░рж┐ржкрзНрж▓рж╛ржЗ ржЪрж╛ржУрзЯрж╛рж░ ржмрж╛рж░рзНрждрж╛ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...`);
    userPrompt = "";
  } else if (userPrompt.startsWith(BAD_WORD_PROMPT_KEY)) {
    const badWordContext = userPrompt
      .substring(BAD_WORD_PROMPT_KEY.length)
      .trim();
    specialPromptInstruction = `[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ: ржПржХржЬржи ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА ржЧрзНрж░рзБржкрзЗ ржПржХржЯрж┐ ржЦрж╛рж░рж╛ржк рж╢ржмрзНржж (${
      badWordContext || "ржЕржЬрж╛ржирж╛"
    }) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрзЗред рждрзБржорж┐ **"ржЖрж╕рзНрждрж╛ржЧржлрж┐рж░рзБрж▓рзНрж▓рж╛рж╣" ржжрж┐рзЯрзЗ рж╢рзБрж░рзБ** ржХрж░рзЗ, рж╢рж┐ржЬрзБржХрж╛ рж╕рзНржЯрж╛ржЗрж▓рзЗ ржорж┐рж╖рзНржЯрж┐ ржХрж░рзЗ ржХрж┐ржирзНрждрзБ ржжрзГрзЭржнрж╛ржмрзЗ ржмрж▓рзЛ ржпрзЗ ржЧрзНрж░рзБржкрзЗ ржЧрж╛рж▓рж┐ржЧрж╛рж▓рж╛ржЬ ржХрж░рж╛ ржмрж╛ ржЦрж╛рж░рж╛ржк ржнрж╛рж╖рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржЙржЪрж┐ржд ржирзЯ, ржПрждрзЗ ржЖрж▓рзНрж▓рж╛рж╣ ржЧрзБржирж╛рж╣ ржжрзЗржи ржПржмржВ ржЧрзНрж░рзБржкрзЗрж░ ржкрж░рж┐ржмрзЗрж╢ ржирж╖рзНржЯ рж╣рзЯред рждрж╛ржХрзЗ ржнржжрзНрж░ржнрж╛ржмрзЗ ржХржерж╛ ржмрж▓рждрзЗ ржЕржирзБрж░рзЛржз ржХрж░рзЛред **ржкрзНрж░рждрж┐ржмрж╛рж░ ржнрж┐ржирзНржи ржнрж┐ржирзНржи ржмрж╛ржХрзНржп** ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗред]`;
    console.log(`[Gemini Special] ржЧрж╛рж▓рж┐ ржУрзЯрж╛рж░рзНржирж┐ржВ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...`);
    userPrompt = "";
  }

  // ржЦ. Teach ржбрзЗржЯрж╛ ржЪрзЗржХ ржХрж░рж╛ (ржпржжрж┐ ржирж╛ ржПржЯрж╛ ржмрж┐рж╢рзЗрж╖ ржкрзНрж░ржорзНржкржЯ рж╣рзЯ)
  if (!specialPromptInstruction) {
    const taughtAnswer = teachManager.findAnswer(userPrompt);
    if (taughtAnswer) {
      console.log(
        `[Teach System] "${userPrompt.substring(
          0,
          30
        )}..." ржПрж░ ржЬржирзНржп рж╢рзЗржЦрж╛ржирзЛ ржЙрждрзНрждрж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред`
      );
      return taughtAnswer + " ЁЯШК";
    }
  }

  // ржЧ. рж╕рж░рзНржмржжрж╛ рж╕ржорзЯ ржУ ржжрж┐ржирзЗрж░ ржЕржВрж╢ ржЗржиржЬрзЗржХрзНржЯ ржХрж░рж╛
  const { time, date, day, dayPart } = getCurrentTimeInfo();
  const timeContextNote = `[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ (рж╕рж░рзНржмржжрж╛ ржкрзНрж░ржпрзЛржЬрзНржп): ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ ${time}, ${dayPart} ржмрзЗрж▓рж╛ред ржЖржЬржХрзЗрж░ рждрж╛рж░рж┐ржЦ ${date}, ${day}ред ржПржЗ рж╕ржорзЯржЬрзНржЮрж╛ржи рждрзЛржорж╛рж░ ржЙрждрзНрждрж░рзЗ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХржнрж╛ржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЛред ржПржЗ ржирзЛржЯржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржХрзЗ ржжрзЗржЦрж╛ржмрзЗ ржирж╛ред]`;

  // ржШ. рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯ/ржмрзНржпржХрзНрждрж┐ржЧржд ржмрж╛рж░рзНрждрж╛ ржирж┐рж░рзНржзрж╛рж░ржг ржУ ржЪрзВрзЬрж╛ржирзНржд ржкрзНрж░ржорзНржкржЯ рждрзИрж░рж┐
  const isScheduledTask = threadID.startsWith("SCHEDULED_TASK_");
  let finalUserPrompt = userPrompt;
  let systemInstruction = "";

  if (specialPromptInstruction) {
    // ржмрж┐рж╢рзЗрж╖ ржкрзНрж░ржорзНржкржЯрзЗрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ рж╢рзБржзрзБ рж╕рзЗржЗ ржирж┐рж░рзНржжрзЗрж╢ржирж╛ ржПржмржВ рж╕ржорзЯ ржЬрзНржЮрж╛ржи
    finalUserPrompt = `${timeContextNote}\n${specialPromptInstruction}`;
  } else if (isScheduledTask) {
    systemInstruction = `[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ: ржПржЯрж┐ ржПржХржЯрж┐ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯ ржмрж╛рж░рзНрждрж╛ ржпрж╛ ржЧрзНрж░рзБржкрзЗрж░ **рж╕ржмрж╛рж░ ржЙржжрзНржжрзЗрж╢рзНржпрзЗ** ржмрж▓рж╛ рж╣ржЪрзНржЫрзЗред ржЙрждрзНрждрж░рзЗ ржЕржмрж╢рзНржпржЗ 'ржЖржкржирж╛рж░рж╛', 'ржЖржкржирж╛ржжрзЗрж░', 'рж╕ржмрж╛ржЗ' ржЗрждрзНржпрж╛ржжрж┐ **ржмрж╣рзБржмржЪржи** ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗред **ржХрзЛржирзЛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж▓рж┐ржЩрзНржЧржмрж╛ржЪржХ рж╕ржорзНржмрзЛржзржи (ржнрж╛ржЗрзЯрж╛/ржЖржкрзБ) ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗ ржирж╛**ред рж╕рж┐ржЬрзБржХрж╛рж░ ржорзВрж▓ ржмрзНржпржХрзНрждрж┐рждрзНржм (рзн ржмржЫрж░ ржмрзЯрж╕рзА, ржорж┐рж╖рзНржЯрж┐, ржкрзНрж░ржЪрзБрж░ ржЗржорзЛржЬрж┐ ржУ рж╕рзНржЯрж╛ржЗрж▓) ржмржЬрж╛рзЯ рж░рж╛ржЦржмрзЗред ржПржЗ ржирзЛржЯржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржХрзЗ ржжрзЗржЦрж╛ржмрзЗ ржирж╛ред]`;
    finalUserPrompt = `${timeContextNote}\n${systemInstruction}\n\nржорзВрж▓ ржЯржкрж┐ржХ: "${finalUserPrompt}"`;
  } else if (senderName) {
    // ржЧрж╛рж▓рж┐/ржЕржкржорж╛ржи ржЪрзЗржХ ржУ рж░рзЛрж╕рзНржЯрж┐ржВ ржирж┐рж░рзНржжрзЗрж╢ржирж╛
    systemInstruction = `[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ: ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░ ржирж╛ржо "${senderName}"ред **ржкрзНрж░ржержорзЗ** рждрж╛рж░ ржкрзНрж░рж╢рзНржиржЯрж┐ ("${finalUserPrompt}") ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзЗ ржжрзЗржЦрзЛ ржПрждрзЗ ржХрзЛржирзЛ **ржЧрж╛рж▓рж┐ржЧрж╛рж▓рж╛ржЬ, ржЕржкржорж╛ржи ржмрж╛ ржЕрж╢рзНрж▓рзАрж▓ ржЗржЩрзНржЧрж┐ржд** ржЖржЫрзЗ ржХрж┐ржирж╛ред
        * **ржпржжрж┐ ржерж╛ржХрзЗ:** рж╕рж░рж╛рж╕рж░рж┐ persona.txt-ржПрж░ **"рж░рзЛрж╕рзНржЯрж┐ржВ (ржЖрждрзНржорж░ржХрзНрж╖рж╛)"** ржирж┐рж░рзНржжрзЗрж╢ржирж╛ ржЕржирзБржпрж╛рзЯрзА ржПржХржЯрж┐ ржмрзБржжрзНржзрж┐ржжрзАржкрзНржд, рж╕рзНржпрж╛ржнрзЗржЬ ржХрж┐ржирзНрждрзБ ржнржжрзНрж░ ржЙрждрзНрждрж░ ржжрж╛ржУ (ржЙржжрж╛рж╣рж░ржг ржХржкрж┐ ржирж╛ ржХрж░рзЗ)ред
        * **ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ:** рждрж╛рж╣рж▓рзЗ рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХржнрж╛ржмрзЗ рж▓рж┐ржЩрзНржЧ ржЕржирзБржорж╛ржи ржХрж░рзЗ ('ржЖржкрзБ'/'ржнрж╛ржЗрзЯрж╛') рждрж╛рж░ ржкрзНрж░рж╢рзНржирзЗрж░ ржЙрждрзНрждрж░ ржжрж╛ржУред
        рж╕рж░рзНржмржжрж╛ рж╕рж┐ржЬрзБржХрж╛рж░ ржорзВрж▓ ржмрзНржпржХрзНрждрж┐рждрзНржм (ржорж┐рж╖рзНржЯрж┐, ржЗржорзЛржЬрж┐, рж╕рзНржЯрж╛ржЗрж▓, AI ржкрж░рж┐ржЪрзЯ ржЧрзЛржкржи) ржмржЬрж╛рзЯ рж░рж╛ржЦржмрзЗред рж╕ржорзЯ ржЬрзНржЮрж╛ржи (${timeContextNote}) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЛред ржПржЗ ржирзЛржЯржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржХрзЗ ржжрзЗржЦрж╛ржмрзЗ ржирж╛ред]`;
    finalUserPrompt = systemInstruction; // ржЪрзВрзЬрж╛ржирзНржд ржкрзНрж░ржорзНржкржЯ ржПржЦржи рж╢рзБржзрзБ ржирж┐рж░рзНржжрзЗрж╢ржирж╛
  } else {
    systemInstruction =
      "[рж╕рж┐рж╕рзНржЯрзЗржо ржирзЛржЯ: рж╕рж┐ржЬрзБржХрж╛рж░ ржорзВрж▓ ржмрзНржпржХрзНрждрж┐рждрзНржм (ржорж┐рж╖рзНржЯрж┐, ржЗржорзЛржЬрж┐, рж╕рзНржЯрж╛ржЗрж▓) ржмржЬрж╛рзЯ рж░рзЗржЦрзЗ ржЙрждрзНрждрж░ ржжрж╛ржУред рж╕ржорзНржнржм рж╣рж▓рзЗ 'ржнрж╛ржЗрзЯрж╛' рж╕ржорзНржмрзЛржзржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛред]";
    finalUserPrompt = `${timeContextNote}\n${systemInstruction}\n\nржХрж╛ржЬ/ржкрзНрж░рж╢рзНржи: "${finalUserPrompt}"`;
  }

  // ржЩ. ржкрзБрж░ржирзЛ ржЗрждрж┐рж╣рж╛рж╕ рж▓рзЛржб ржХрж░рж╛
  const historyKey = String(threadID);
  let currentHistory = conversationHistory.get(historyKey)?.history || [
    { role: "user", parts: [{ text: shizukaPersona }] },
    {
      role: "model",
      parts: [
        { text: "ржЖржорж┐ рж╕рж┐ржЬрзБржХрж╛, ржЖржкржирж╛рж░ ржмржирзНржзрзБред ржмрж▓рзБржи ржХрж┐ржнрж╛ржмрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржкрж╛рж░рж┐? ЁЯМ╕" },
      ],
    },
  ];

  // ржЪ. ржирждрзБржи ржорзЗрж╕рзЗржЬ ржЗрждрж┐рж╣рж╛рж╕рзЗ ржпрзЛржЧ ржХрж░рж╛
  currentHistory.push({ role: "user", parts: [{ text: finalUserPrompt }] });

  // ржЫ. ржЗрждрж┐рж╣рж╛рж╕ ржЫрж╛ржБржЯрж╛ржЗ
  if (currentHistory.length > HISTORY_MAX_LENGTH * 2) {
    currentHistory = [
      currentHistory[0],
      currentHistory[1],
      ...currentHistory.slice(-(HISTORY_MAX_LENGTH * 2 - 2)),
    ];
  }

  // ржЬ. ржЬрзЗржорж┐ржирж┐ржХрзЗ ржХрж▓ ржХрж░рж╛ (ржорж╛рж▓рзНржЯрж┐-ржХрзА ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ)
  try {
    const apiKey = getNextApiKey();
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: modelName });

    const chat = model.startChat({ history: currentHistory });
    const messageToSend = specialPromptInstruction ? "..." : userPrompt;
    const result = await chat.sendMessage(messageToSend);
    const response = await result.response;

    if (!response || !response.text) {
      throw new Error("Gemini ржерзЗржХрзЗ ржЦрж╛рж▓рж┐ ржЙрждрзНрждрж░ ржПрж╕рзЗржЫрзЗред");
    }
    const botReply = response.text();

    // ржЭ. ржмржЯрзЗрж░ ржЙрждрзНрждрж░ ржЗрждрж┐рж╣рж╛рж╕рзЗ рж╕рзЗржн ржХрж░рж╛ (ржпржжрж┐ ржирж╛ рж╢рж┐ржбрж┐ржЙрж▓ржб/рж╕рзНржкрзЗрж╢рж╛рж▓ ржЯрж╛рж╕рзНржХ рж╣рзЯ)
    if (!isScheduledTask && !specialPromptInstruction) {
      currentHistory.push({ role: "model", parts: [{ text: botReply }] });
      if (currentHistory.length > HISTORY_MAX_LENGTH * 2) {
        currentHistory = [
          currentHistory[0],
          currentHistory[1],
          ...currentHistory.slice(-(HISTORY_MAX_LENGTH * 2 - 2)),
        ];
      }
      conversationHistory.set(historyKey, {
        history: currentHistory,
        timestamp: Date.now(),
      });
    }
    return botReply;
  } catch (error) {
    console.error(
      `тЭМ Gemini AI Error (gemini.js) | Key Index: ${currentApiKeyIndex} | Thread: ${historyKey}`
    );
    let specificErrorMessage =
      "ржЙржлржл! ржЖржорж╛рж░ ржЙрждрзНрждрж░ ржЦрзБржБржЬрзЗ ржЖржирждрзЗ ржПржХржЯрзБ рж╕ржорж╕рзНржпрж╛ рж╣ржЪрзНржЫрзЗред ЁЯШе ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░ржмрзЗржи?";
    if (error.message && error.message.includes("429")) {
      specificErrorMessage =
        "ржжрзБржГржЦрж┐ржд, ржЖржорж┐ ржПржЦржи ржПржХржЯрзБ ржмрзЗрж╢рж┐ ржмрзНржпрж╕рзНрждред ЁЯШе ржХрж┐ржЫрзБржХрзНрж╖ржг ржкрж░ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред (API Limit)";
    } else if (error.message && error.message.includes("SAFETY")) {
      specificErrorMessage =
        "ржжрзБржГржЦрж┐ржд, ржЖржкржирж╛рж░ ржкрзНрж░рж╢рзНржиржЯрж┐ ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐ ржирж╛ ржмрж╛ ржЙрждрзНрждрж░ ржжрж┐рждрзЗ ржкрж╛рж░ржЫрж┐ ржирж╛ред ЁЯе║ ржЕржирзНржпржнрж╛ржмрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░ржмрзЗржи?";
    } else if (error.message && error.message.includes("API key not valid")) {
      console.error(
        `FATAL: API Key at index ${currentApiKeyIndex} is invalid! Please check config.json.`
      );
      specificErrorMessage =
        "ржПржХржЯрж┐ API Key рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред ржЕрзНржпрж╛ржбржорж┐ржи рж╢рзАржШрзНрж░ржЗ ржарж┐ржХ ржХрж░ржмрзЗржиред";
    } else {
      console.error("Unknown Gemini Error Details:", error);
    }
    throw new Error(specificErrorMessage);
  }
}

// === рзм. ржлрж╛ржВрж╢ржи ржПржХрзНрж╕ржкрзЛрж░рзНржЯ ===
module.exports = {
  getShizukaReply,
};
